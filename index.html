<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Bel Sekolah Pro</title>

    <link rel="icon" href="favicon.png" type="image/png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap');

        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }

        @keyframes ring-glow {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .alarm-ringing { animation: ring-glow 1.5s infinite; border-color: #ef4444 !important; }

        /* Overlay untuk Resume Audio */
        #resumeOverlay {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen pb-10">

    <!-- OVERLAY RESUME (Muncul jika refresh saat aktif) -->
    <div id="resumeOverlay" class="fixed inset-0 z-[60] bg-slate-900/80 hidden flex-col items-center justify-center text-center p-6 cursor-pointer" onclick="resumeSystem()">
        <div class="bg-slate-800 p-8 rounded-2xl border border-blue-500 shadow-2xl max-w-sm w-full animate-bounce">
            <i class="fas fa-play-circle text-6xl text-blue-500 mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">Sistem Sedang Berjalan</h2>
            <p class="text-slate-300 text-sm">Klik di mana saja untuk menyambungkan kembali audio dan melanjutkan monitoring alarm.</p>
        </div>
    </div>

    <!-- AUDIO ELEMENT -->
    <audio id="customAlarmAudio" src="bel.mp3" preload="auto" playsinline onerror="handleAudioError(event)"></audio>

    <!-- Navbar -->
    <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-50 shadow-lg transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i class="fas fa-school text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white leading-tight">Sistem Bel Sekolah</h1>
                        <p class="text-xs text-slate-400">Dashboard Kontrol Otomatis</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div id="nextAlarmBadge" class="hidden md:flex flex-col items-end mr-4">
                        <span class="text-[10px] uppercase tracking-wider text-slate-400">Jadwal Berikutnya</span>
                        <span id="nextAlarmTime" class="text-yellow-400 font-mono font-bold">--:--</span>
                    </div>
                    <button id="audioToggleBtn" onclick="toggleSystem()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded-lg border border-slate-600 transition-all">
                        <div id="statusDot" class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span id="statusText" class="font-semibold text-sm">Sistem Mati</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

            <!-- 1. Jam Digital -->
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fas fa-clock text-9xl text-blue-500"></i>
                </div>
                <h2 class="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-2">Waktu Saat Ini</h2>
                <div id="clockDisplay" class="font-mono text-5xl md:text-6xl font-bold text-white tracking-tight mb-2">00:00:00</div>
                <div id="dateDisplay" class="text-blue-400 font-medium">Memuat tanggal...</div>
            </div>

            <!-- 2. Alarm Kustom (FITUR BARU) -->
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl flex flex-col">
                <h2 class="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-4">Alarm Sekali Jalan</h2>
                <div class="flex-1 flex flex-col justify-center">
                    <div class="flex gap-2 mb-3">
                        <input type="time" id="customTimeInput" class="bg-slate-900 border border-slate-600 text-white text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 font-mono" required>
                        <button onclick="setCustomAlarm()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            <i class="fas fa-plus"></i> Set
                        </button>
                    </div>

                    <!-- Daftar Custom Alarm -->
                    <div id="customAlarmList" class="space-y-2">
                        <!-- Akan diisi JS jika ada -->
                        <div class="text-xs text-slate-500 italic text-center">Belum ada alarm kustom.</div>
                    </div>
                </div>
            </div>

            <!-- 3. Panel Kontrol Manual -->
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl flex flex-col justify-between">
                <div>
                    <h2 class="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-4">Kontrol Manual</h2>

                    <div id="audioFileStatus" class="mb-3 text-[10px] bg-slate-900 p-2 rounded text-slate-400 flex items-center gap-2">
                        <i class="fas fa-spinner fa-spin text-blue-500"></i> Memeriksa file bel.mp3...
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="testAlarm()" class="flex flex-col items-center justify-center p-3 bg-slate-700 hover:bg-slate-600 rounded-xl border border-slate-600 transition-colors group">
                            <i class="fas fa-play text-blue-400 mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs font-bold text-slate-300">Test Suara</span>
                        </button>
                        <button id="stopBtn" onclick="stopAlarmManual()" disabled class="flex flex-col items-center justify-center p-3 bg-slate-700 rounded-xl border border-slate-600 transition-colors opacity-50 cursor-not-allowed">
                            <i class="fas fa-stop text-red-400 mb-2"></i>
                            <span class="text-xs font-bold text-slate-300">Stop Alarm</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jadwal Header -->
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-white"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Jadwal Mingguan</h2>
            <div class="flex gap-4">
                <div class="text-xs text-slate-400 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                    <i class="fas fa-info-circle mr-1"></i> Data Tersimpan Otomatis
                </div>
                <button onclick="resetToDefault()" class="text-xs text-slate-400 hover:text-white underline">Reset Default</button>
            </div>
        </div>

        <div id="scheduleGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>

    </main>

    <script>
        const defaultSchedule = {
            "Senin":  ["08:30", "09:50", "11:30", "13:05"],
            "Selasa": ["08:30", "09:50", "11:30", "13:05"],
            "Rabu":   ["08:30", "09:50", "11:30", "13:05"],
            "Kamis":  ["08:30", "09:50", "11:30", "13:05"],
            "Jumat":  ["08:30", "09:50"],
            "Sabtu":  ["08:30", "09:50", "11:30", "13:05"]
        };

        let alarmConfig = {};
        let audioContext = null;
        let isSystemActive = false;
        let isRinging = false;
        let oscillator = null;
        let lastTriggeredDayTime = "";
        let wakeLock = null;

        // CUSTOM ALARM VARS
        let customAlarms = []; // Array of string "HH:MM"

        // --- HANDLER ERROR AUDIO ---
        function handleAudioError(e) {
            const statusEl = document.getElementById('audioFileStatus');
            const audio = e.target;
            let msg = "Terjadi kesalahan.";
            if (audio.error) {
                switch (audio.error.code) {
                    case 1: msg = "Pemuatan dibatalkan user."; break;
                    case 2: msg = "Masalah jaringan/koneksi."; break;
                    case 3: msg = "Error Decode (File rusak?)"; break;
                    case 4: msg = "File bel.mp3 TIDAK DITEMUKAN."; break;
                }
            }
            statusEl.innerHTML = `<i class="fas fa-exclamation-triangle text-red-500"></i> <span class="text-red-400">${msg}</span>`;
        }

        window.addEventListener('load', () => {
            const audio = document.getElementById('customAlarmAudio');
            setTimeout(() => {
                const statusEl = document.getElementById('audioFileStatus');
                if (!audio.error) {
                    if (audio.readyState >= 2) {
                        statusEl.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> <span class="text-green-400">File bel.mp3 Siap.</span>`;
                    } else {
                        statusEl.innerHTML = `<i class="fas fa-question-circle text-yellow-500"></i> <span class="text-yellow-400">Menunggu file... (Cek nama file)</span>`;
                    }
                }
            }, 1000);

            // CEK STATUS TERAKHIR SETELAH REFRESH
            checkLastState();
        });

        function checkLastState() {
            const wasActive = localStorage.getItem('isSystemActive') === 'true';
            if (wasActive) {
                // Tampilkan Overlay untuk meminta gesture klik user
                const overlay = document.getElementById('resumeOverlay');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }
        }

        // Fungsi dipanggil saat overlay diklik
        function resumeSystem() {
            const overlay = document.getElementById('resumeOverlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');

            // Aktifkan sistem tanpa toggle (force ON)
            if (!isSystemActive) {
                toggleSystem();
            }
        }

        function init() {
            loadConfig();
            loadCustomAlarms(); // Load alarm kustom
            renderScheduleUI();
            updateClock();
            setInterval(updateClock, 1000);

            document.addEventListener("visibilitychange", async () => {
                if (wakeLock !== null && document.visibilityState === "visible") {
                    requestWakeLock();
                }
            });
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.log('Wake Lock Info:', err); }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release().then(() => wakeLock = null);
            }
        }

        function loadConfig() {
            const saved = localStorage.getItem('schoolAlarmConfig_v2');
            if (saved) {
                alarmConfig = JSON.parse(saved);
            } else {
                resetToDefault();
            }
        }

        function saveConfig() {
            localStorage.setItem('schoolAlarmConfig_v2', JSON.stringify(alarmConfig));
            findNextAlarm();
        }

        // --- CUSTOM ALARM LOGIC ---
        function setCustomAlarm() {
            const input = document.getElementById('customTimeInput');
            const time = input.value;
            if(!time) return;

            if(!customAlarms.includes(time)) {
                customAlarms.push(time);
                // Sort
                customAlarms.sort();
                saveCustomAlarms();
                renderCustomAlarms();
                input.value = '';

                // Feedback visual
                if(isSystemActive) {
                    new Notification("Alarm Kustom", { body: `Alarm diset untuk jam ${time}` });
                }
            }
        }

        function removeCustomAlarm(time) {
            customAlarms = customAlarms.filter(t => t !== time);
            saveCustomAlarms();
            renderCustomAlarms();
        }

        function saveCustomAlarms() {
            localStorage.setItem('customAlarms', JSON.stringify(customAlarms));
        }

        function loadCustomAlarms() {
            const saved = localStorage.getItem('customAlarms');
            if(saved) {
                customAlarms = JSON.parse(saved);
                renderCustomAlarms();
            }
        }

        function renderCustomAlarms() {
            const list = document.getElementById('customAlarmList');
            if(customAlarms.length === 0) {
                list.innerHTML = `<div class="text-xs text-slate-500 italic text-center">Belum ada alarm kustom.</div>`;
                return;
            }

            let html = '';
            customAlarms.forEach(time => {
                html += `
                <div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700">
                    <span class="font-mono text-yellow-400 font-bold">${time}</span>
                    <button onclick="removeCustomAlarm('${time}')" class="text-red-400 hover:text-red-300">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>`;
            });
            list.innerHTML = html;
        }

        function resetToDefault() {
            if(Object.keys(alarmConfig).length > 0 && !confirm("Kembalikan semua pengaturan jadwal ke awal?")) return;
            alarmConfig = {};
            for (const day in defaultSchedule) {
                alarmConfig[day] = {};
                defaultSchedule[day].forEach(time => alarmConfig[day][time] = true);
            }
            if(localStorage.getItem('schoolAlarmConfig_v2')) saveConfig();
            renderScheduleUI();
        }

        function renderScheduleUI() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            const daysOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const todayName = new Date().toLocaleDateString('id-ID', { weekday: 'long' });

            daysOrder.forEach(day => {
                const isToday = (day === todayName);
                const times = alarmConfig[day] || {};
                const sortedTimes = Object.keys(times).sort();

                let html = `
                <div class="bg-slate-800 rounded-xl border ${isToday ? 'border-blue-500 shadow-blue-900/20 shadow-lg' : 'border-slate-700'} overflow-hidden flex flex-col">
                    <div class="p-4 ${isToday ? 'bg-blue-600/10' : 'bg-slate-800'} border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold ${isToday ? 'text-blue-400' : 'text-slate-300'} text-lg">${day}</h3>
                        ${isToday ? '<span class="text-xs bg-blue-500 text-white px-2 py-0.5 rounded-full">HARI INI</span>' : ''}
                    </div>
                    <div class="p-4 space-y-3 flex-1">
                `;

                if (sortedTimes.length === 0) {
                    html += `<p class="text-slate-500 text-sm italic text-center py-4">Tidak ada jadwal</p>`;
                } else {
                    sortedTimes.forEach(time => {
                        const isActive = times[time];
                        const inputId = `chk-${day}-${time}`;
                        html += `
                        <div class="flex items-center justify-between p-3 rounded-lg bg-slate-900/50 border border-slate-700/50 hover:border-slate-600 transition-colors">
                            <span class="font-mono text-lg ${isActive ? 'text-white' : 'text-slate-500 decoration-slate-600'}">${time}</span>
                            <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="${inputId}" id="${inputId}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-700 checked:right-0 checked:border-blue-600 transition-all duration-300"
                                ${isActive ? 'checked' : ''}
                                onchange="toggleTime('${day}', '${time}')"/>
                                <label for="${inputId}" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-700 cursor-pointer checked:bg-blue-600 transition-colors duration-300"></label>
                            </div>
                        </div>`;
                    });
                }
                html += `</div></div>`;
                grid.innerHTML += html;
            });
        }

        function toggleTime(day, time) {
            alarmConfig[day][time] = !alarmConfig[day][time];
            saveConfig();
            const input = document.getElementById(`chk-${day}-${time}`);
            const timeDisplay = input.parentElement.previousElementSibling;
            if(alarmConfig[day][time]) {
                timeDisplay.classList.remove('text-slate-500', 'decoration-slate-600');
                timeDisplay.classList.add('text-white');
            } else {
                timeDisplay.classList.add('text-slate-500');
                timeDisplay.classList.remove('text-white');
            }
        }

        function updateClock() {
            const now = new Date();
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const dayName = days[now.getDay()];
            document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('dateDisplay').textContent = `${dayName}, ${now.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            checkAlarm(now, dayName);
        }

        function checkAlarm(now, dayName) {
            if (!isSystemActive || isRinging) return;

            const currentHM = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false }).replace('.', ':');

            // 1. CEK CUSTOM ALARM
            if (customAlarms.includes(currentHM)) {
                const triggerId = `CUSTOM-${currentHM}`;
                if (lastTriggeredDayTime !== triggerId) {
                    triggerAlarm(currentHM, false);
                    lastTriggeredDayTime = triggerId;

                    // Hapus alarm kustom setelah bunyi (sekali pakai)
                    removeCustomAlarm(currentHM);
                    return; // Prioritas ke Custom, skip jadwal reguler detik ini
                }
            }

            // 2. CEK JADWAL REGULER
            if (dayName === 'Minggu') return;
            if (alarmConfig[dayName] && alarmConfig[dayName][currentHM]) {
                const triggerId = `${dayName}-${currentHM}`;
                if (lastTriggeredDayTime !== triggerId) {
                    triggerAlarm(currentHM, false);
                    lastTriggeredDayTime = triggerId;
                }
            }
        }

        function triggerAlarm(time, isTest = false) {
            isRinging = true;

            const nav = document.querySelector('nav');
            nav.classList.add('alarm-ringing', 'border-red-500');
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-slate-700');
            stopBtn.classList.add('bg-red-600', 'animate-pulse', 'hover:bg-red-500');

            // PRIORITAS AUDIO
            if (isTest) {
                const customAudio = document.getElementById('customAlarmAudio');
                customAudio.currentTime = 0;
                const playPromise = customAudio.play();

                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        customAudio.onended = () => { if(isRinging) stopAlarmManual(); };
                    }).catch(error => {
                        console.warn("MP3 Gagal (Test):", error);
                        playOscillatorAlarm();
                    });
                }
            } else {
                playAlarmSoundWithFallback();
            }

            // NOTIFIKASI
            if (Notification.permission === "granted") {
                try {
                    new Notification("ALARM SEKOLAH", { body: `Saatnya pergantian jam: ${time}`, icon: 'favicon.png' });
                } catch (e) {
                    console.warn("Notifikasi visual gagal:", e);
                }
            }
        }

        function stopAlarmManual() {
            isRinging = false;
            stopSound();
            const nav = document.querySelector('nav');
            nav.classList.remove('alarm-ringing', 'border-red-500');
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-slate-700');
            stopBtn.classList.remove('bg-red-600', 'animate-pulse', 'hover:bg-red-500');
        }

        function toggleSystem() {
            const btn = document.getElementById('audioToggleBtn');
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if (!isSystemActive) {
                // AKTIFKAN
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if(AudioContext) {
                    audioContext = new AudioContext();
                    audioContext.resume();
                }

                const customAudio = document.getElementById('customAlarmAudio');
                customAudio.play().then(() => {
                    setTimeout(() => {
                        customAudio.pause();
                        customAudio.currentTime = 0;
                    }, 150);
                }).catch(e => {
                    console.log("Warning Unlock Audio: ", e);
                });

                requestWakeLock();
                isSystemActive = true;
                localStorage.setItem('isSystemActive', 'true'); // SIMPAN STATE

                btn.classList.remove('bg-slate-700', 'border-slate-600');
                btn.classList.add('bg-slate-800', 'border-green-500', 'text-green-400');
                dot.classList.remove('bg-red-500');
                dot.classList.add('bg-green-500', 'animate-pulse');
                text.textContent = "Sistem AKTIF";

                try {
                    if (Notification.permission !== "granted") Notification.requestPermission();
                } catch(e) { console.log("Izin notifikasi error:", e); }

                findNextAlarm();

            } else {
                // MATIKAN
                isSystemActive = false;
                localStorage.setItem('isSystemActive', 'false'); // SIMPAN STATE
                stopAlarmManual();
                releaseWakeLock();

                btn.classList.add('bg-slate-700', 'border-slate-600');
                btn.classList.remove('bg-slate-800', 'border-green-500', 'text-green-400');
                dot.classList.add('bg-red-500');
                dot.classList.remove('bg-green-500', 'animate-pulse');
                text.textContent = "Sistem Mati";
            }
        }

        function playAlarmSoundWithFallback() {
            const customAudio = document.getElementById('customAlarmAudio');
            const playPromise = customAudio.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    customAudio.onended = () => { if(isRinging) stopAlarmManual(); };
                })
                .catch(error => {
                    console.log("MP3 Autoplay Fail:", error);
                    playOscillatorAlarm();
                });
            } else {
                playOscillatorAlarm();
            }
        }

        function playOscillatorAlarm() {
            if (!audioContext) {
                 const AudioContext = window.AudioContext || window.webkitAudioContext;
                 if(AudioContext) audioContext = new AudioContext();
            }
            if (!audioContext) return;

            oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(500, audioContext.currentTime);

            const now = audioContext.currentTime;
            for(let i=0; i<10; i++) {
               oscillator.frequency.linearRampToValueAtTime(800, now + i*2 + 0.5);
               oscillator.frequency.linearRampToValueAtTime(500, now + i*2 + 1.0);
               oscillator.frequency.linearRampToValueAtTime(800, now + i*2 + 1.5);
               oscillator.frequency.linearRampToValueAtTime(500, now + i*2 + 2.0);
            }

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 20);
            oscillator.onended = () => { if(isRinging) stopAlarmManual(); };
        }

        function stopSound() {
            const customAudio = document.getElementById('customAlarmAudio');
            customAudio.pause();
            customAudio.currentTime = 0;

            if (oscillator) {
                try { oscillator.stop(); oscillator.disconnect(); } catch(e){}
                oscillator = null;
            }
        }

        function testAlarm() {
            if (!isSystemActive) {
                alert("Klik tombol 'Sistem Mati' di pojok kanan atas dulu sampai berubah jadi AKTIF.");
                return;
            }
            triggerAlarm("UJI COBA", true);
        }

        function findNextAlarm() {
            const now = new Date();
            const dayName = now.toLocaleDateString('id-ID', { weekday: 'long' });

            const currentHM = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false }).replace('.', ':');

            // Cek Custom Alarm Terdekat
            const nextCustom = customAlarms.find(t => t > currentHM);

            // Cek Regular Alarm
            let nextRegular = null;
            if (dayName !== 'Minggu') {
                const times = alarmConfig[dayName] || {};
                const sorted = Object.keys(times).sort();
                nextRegular = sorted.find(t => t > currentHM && times[t] === true);
            }

            // Tentukan mana yang lebih dulu
            let display = "Besok";
            if (nextCustom && nextRegular) {
                display = (nextCustom < nextRegular) ? "Kustom " + nextCustom : nextRegular;
            } else if (nextCustom) {
                display = "Kustom " + nextCustom;
            } else if (nextRegular) {
                display = nextRegular;
            }

            document.getElementById('nextAlarmTime').textContent = display;
        }

        init();
    </script>
</body>
</html>
