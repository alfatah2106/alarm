<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Bel Sekolah Pro</title>

    <!-- FAVICON: Siapkan file favicon.png di folder yang sama -->
    <link rel="icon" href="favicon.png" type="image/png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap');

        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }

        /* Animasi Alarm */
        @keyframes ring-glow {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .alarm-ringing {
            animation: ring-glow 1.5s infinite;
            border-color: #ef4444 !important;
        }

        /* Scrollbar Halus */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen pb-10">

    <!-- AUDIO ELEMENT CUSTOM -->
    <!-- Siapkan file bel.mp3 di folder yang sama. Jika tidak ada, sistem pakai fallback bunyi digital. -->
    <audio id="customAlarmAudio" src="bel.mp3" preload="auto"></audio>

    <!-- Navbar / Header -->
    <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-50 shadow-lg transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i class="fas fa-school text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white leading-tight">Sistem Bel Sekolah</h1>
                        <p class="text-xs text-slate-400">Dashboard Kontrol Otomatis</p>
                    </div>
                </div>

                <!-- Status Audio Kanan -->
                <div class="flex items-center gap-4">
                    <div id="nextAlarmBadge" class="hidden md:flex flex-col items-end mr-4">
                        <span class="text-[10px] uppercase tracking-wider text-slate-400">Jadwal Berikutnya</span>
                        <span id="nextAlarmTime" class="text-yellow-400 font-mono font-bold">--:--</span>
                    </div>
                    <button id="audioToggleBtn" onclick="toggleSystem()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded-lg border border-slate-600 transition-all">
                        <div id="statusDot" class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span id="statusText" class="font-semibold text-sm">Sistem Mati</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">

        <!-- Top Section: Clock & Master Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Jam Digital -->
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fas fa-clock text-9xl text-blue-500"></i>
                </div>
                <h2 class="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-2">Waktu Saat Ini</h2>
                <div id="clockDisplay" class="font-mono text-5xl md:text-6xl font-bold text-white tracking-tight mb-2">00:00:00</div>
                <div id="dateDisplay" class="text-blue-400 font-medium">Memuat tanggal...</div>
            </div>

            <!-- Panel Kontrol Manual -->
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl flex flex-col justify-between">
                <div>
                    <h2 class="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-4">Kontrol Manual</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="testAlarm()" class="flex flex-col items-center justify-center p-3 bg-slate-700 hover:bg-slate-600 rounded-xl border border-slate-600 transition-colors group">
                            <i class="fas fa-play text-blue-400 mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs font-bold text-slate-300">Test Suara</span>
                        </button>
                        <button id="stopBtn" onclick="stopAlarmManual()" disabled class="flex flex-col items-center justify-center p-3 bg-slate-700 rounded-xl border border-slate-600 transition-colors opacity-50 cursor-not-allowed">
                            <i class="fas fa-stop text-red-400 mb-2"></i>
                            <span class="text-xs font-bold text-slate-300">Stop Alarm</span>
                        </button>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-700">
                    <p class="text-xs text-slate-500"><i class="fas fa-file-audio mr-1"></i> Prioritas Audio: <b>bel.mp3</b> (Fallback: Digital Beep)</p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                 <h2 class="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-4">Status Jadwal Hari Ini</h2>
                 <div id="todayStats" class="space-y-4">
                     <!-- Diisi via JS -->
                     <div class="animate-pulse bg-slate-700 h-20 rounded-lg"></div>
                 </div>
            </div>
        </div>

        <!-- Schedule Grid Header -->
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-white"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Jadwal Mingguan</h2>
            <button onclick="resetToDefault()" class="text-xs text-slate-400 hover:text-white underline">Reset ke Default</button>
        </div>

        <!-- Schedule Grid Container -->
        <div id="scheduleGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <!-- Cards akan digenerate oleh JavaScript -->
        </div>

    </main>

    <!-- Script Logic -->
    <script>
        /**
         * PENTING UNTUK PEMISAHAN FILE:
         * Jika Anda ingin memisahkan file ini:
         * 1. Buat file baru bernama 'script.js'
         * 2. Copy SEMUA kode di dalam tag <script> ini ke file 'script.js'
         * 3. Di file HTML, hapus kode ini dan ganti dengan: <script src="script.js"><\/script>
         */

        // --- DATA DEFAULT ---
        const defaultSchedule = {
            "Senin":  ["08:30", "09:50", "11:30", "13:05"],
            "Selasa": ["08:30", "09:50", "11:30", "13:05"],
            "Rabu":   ["08:30", "09:50", "11:30", "13:05"],
            "Kamis":  ["08:30", "09:50", "11:30", "13:05"],
            "Jumat":  ["08:30", "09:50"],
            "Sabtu":  ["08:30", "09:50", "11:30", "13:05"]
        };

        // --- STATE VARIABLES ---
        let alarmConfig = {};
        let audioContext = null;
        let isSystemActive = false;
        let isRinging = false;
        let oscillator = null;
        let lastTriggeredDayTime = "";

        // --- INIT & STORAGE ---
        function init() {
            loadConfig();
            renderScheduleUI();
            updateClock();
            setInterval(updateClock, 1000);
            updateTodayStats();
        }

        function loadConfig() {
            const saved = localStorage.getItem('schoolAlarmConfig_v2');
            if (saved) {
                alarmConfig = JSON.parse(saved);
            } else {
                resetToDefault();
            }
        }

        function saveConfig() {
            localStorage.setItem('schoolAlarmConfig_v2', JSON.stringify(alarmConfig));
            updateTodayStats();
            findNextAlarm();
        }

        function resetToDefault() {
            // Logic reset tanpa confirm di awal load, dengan confirm jika dipanggil tombol
            if(Object.keys(alarmConfig).length > 0 && !confirm("Kembalikan semua pengaturan jadwal ke awal?")) return;

            alarmConfig = {};
            for (const day in defaultSchedule) {
                alarmConfig[day] = {};
                defaultSchedule[day].forEach(time => {
                    alarmConfig[day][time] = true;
                });
            }
            // Simpan hanya jika ini bukan inisialisasi awal kosong
            if(localStorage.getItem('schoolAlarmConfig_v2')) saveConfig();
            renderScheduleUI();
        }

        // --- UI RENDERING ---
        function renderScheduleUI() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';

            const daysOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const todayName = new Date().toLocaleDateString('id-ID', { weekday: 'long' });

            daysOrder.forEach(day => {
                const isToday = (day === todayName);
                const times = alarmConfig[day] || {};

                const sortedTimes = Object.keys(times).sort();

                let html = `
                <div class="bg-slate-800 rounded-xl border ${isToday ? 'border-blue-500 shadow-blue-900/20 shadow-lg' : 'border-slate-700'} overflow-hidden flex flex-col">
                    <div class="p-4 ${isToday ? 'bg-blue-600/10' : 'bg-slate-800'} border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold ${isToday ? 'text-blue-400' : 'text-slate-300'} text-lg">${day}</h3>
                        ${isToday ? '<span class="text-xs bg-blue-500 text-white px-2 py-0.5 rounded-full">HARI INI</span>' : ''}
                    </div>
                    <div class="p-4 space-y-3 flex-1">
                `;

                if (sortedTimes.length === 0) {
                    html += `<p class="text-slate-500 text-sm italic text-center py-4">Tidak ada jadwal</p>`;
                } else {
                    sortedTimes.forEach(time => {
                        const isActive = times[time];
                        const inputId = `chk-${day}-${time}`;

                        html += `
                        <div class="flex items-center justify-between p-3 rounded-lg bg-slate-900/50 border border-slate-700/50 hover:border-slate-600 transition-colors">
                            <span class="font-mono text-lg ${isActive ? 'text-white' : 'text-slate-500 decoration-slate-600'}">${time}</span>

                            <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="${inputId}" id="${inputId}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-700 checked:right-0 checked:border-blue-600 transition-all duration-300"
                                ${isActive ? 'checked' : ''}
                                onchange="toggleTime('${day}', '${time}')"/>
                                <label for="${inputId}" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-700 cursor-pointer checked:bg-blue-600 transition-colors duration-300"></label>
                            </div>
                        </div>
                        `;
                    });
                }

                html += `</div></div>`;
                grid.innerHTML += html;
            });
        }

        function toggleTime(day, time) {
            alarmConfig[day][time] = !alarmConfig[day][time];
            saveConfig();

            const input = document.getElementById(`chk-${day}-${time}`);
            const timeDisplay = input.parentElement.previousElementSibling;

            if(alarmConfig[day][time]) {
                timeDisplay.classList.remove('text-slate-500', 'decoration-slate-600');
                timeDisplay.classList.add('text-white');
            } else {
                timeDisplay.classList.add('text-slate-500');
                timeDisplay.classList.remove('text-white');
            }
        }

        // --- CLOCK & ALARM LOGIC ---
        function updateClock() {
            const now = new Date();
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const dayName = days[now.getDay()];

            document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('dateDisplay').textContent = `${dayName}, ${now.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            checkAlarm(now, dayName);
        }

        function checkAlarm(now, dayName) {
            if (!isSystemActive || isRinging) return;
            if (dayName === 'Minggu') return;

            const currentHM = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false }).replace('.', ':');

            if (alarmConfig[dayName] && alarmConfig[dayName][currentHM]) {
                const triggerId = `${dayName}-${currentHM}`;
                if (lastTriggeredDayTime !== triggerId) {
                    triggerAlarm(currentHM);
                    lastTriggeredDayTime = triggerId;
                }
            }
        }

        function triggerAlarm(time) {
            isRinging = true;

            const nav = document.querySelector('nav');
            nav.classList.add('alarm-ringing', 'border-red-500');

            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-slate-700');
            stopBtn.classList.add('bg-red-600', 'animate-pulse', 'hover:bg-red-500');

            if (Notification.permission === "granted") {
                new Notification("ALARM SEKOLAH", {
                    body: `Saatnya pergantian jam: ${time}`,
                    icon: 'favicon.png'
                });
            }

            playAlarmSoundWithFallback();
        }

        function stopAlarmManual() {
            isRinging = false;
            stopSound();

            const nav = document.querySelector('nav');
            nav.classList.remove('alarm-ringing', 'border-red-500');

            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-slate-700');
            stopBtn.classList.remove('bg-red-600', 'animate-pulse', 'hover:bg-red-500');
        }

        // --- AUDIO SYSTEM (HYBRID: MP3 + OSCILLATOR) ---
        function toggleSystem() {
            const btn = document.getElementById('audioToggleBtn');
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if (!isSystemActive) {
                // Init Audio Context untuk Oscillator (Fallback)
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContext.resume().then(() => {
                    isSystemActive = true;

                    // UI Update
                    btn.classList.remove('bg-slate-700', 'border-slate-600');
                    btn.classList.add('bg-slate-800', 'border-green-500', 'text-green-400');
                    dot.classList.remove('bg-red-500');
                    dot.classList.add('bg-green-500', 'animate-pulse');
                    text.textContent = "Sistem AKTIF";

                    if (Notification.permission !== "granted") Notification.requestPermission();

                    // Bunyi Feedback
                    playShortBeep();
                    findNextAlarm();
                });
            } else {
                isSystemActive = false;
                stopAlarmManual();

                btn.classList.add('bg-slate-700', 'border-slate-600');
                btn.classList.remove('bg-slate-800', 'border-green-500', 'text-green-400');
                dot.classList.add('bg-red-500');
                dot.classList.remove('bg-green-500', 'animate-pulse');
                text.textContent = "Sistem Mati";
            }
        }

        function playAlarmSoundWithFallback() {
            const customAudio = document.getElementById('customAlarmAudio');

            // Coba play MP3
            const playPromise = customAudio.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // MP3 berhasil diputar
                    // Setup event listener untuk stop manual jika lagu selesai
                    customAudio.onended = () => {
                        if(isRinging) stopAlarmManual();
                    };
                })
                .catch(error => {
                    console.warn("File bel.mp3 tidak ditemukan atau gagal diputar. Menggunakan Fallback Digital.");
                    // Gagal? Pakai Oscillator
                    playOscillatorAlarm();
                });
            } else {
                playOscillatorAlarm();
            }
        }

        function playOscillatorAlarm() {
            if (!audioContext) return;
            oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(500, audioContext.currentTime);

            const now = audioContext.currentTime;
            for(let i=0; i<10; i++) {
               oscillator.frequency.linearRampToValueAtTime(800, now + i*2 + 0.5);
               oscillator.frequency.linearRampToValueAtTime(500, now + i*2 + 1.0);
               oscillator.frequency.linearRampToValueAtTime(800, now + i*2 + 1.5);
               oscillator.frequency.linearRampToValueAtTime(500, now + i*2 + 2.0);
            }

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 20);

            oscillator.onended = () => {
                if(isRinging) stopAlarmManual();
            };
        }

        function playShortBeep() {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = 600;
            osc.start();
            osc.stop(audioContext.currentTime + 0.1);
        }

        function stopSound() {
            // Stop MP3
            const customAudio = document.getElementById('customAlarmAudio');
            customAudio.pause();
            customAudio.currentTime = 0;

            // Stop Oscillator
            if (oscillator) {
                try { oscillator.stop(); oscillator.disconnect(); } catch(e){}
                oscillator = null;
            }
        }

        function testAlarm() {
            if (!isSystemActive) {
                alert("Aktifkan Sistem dulu (Tombol di pojok kanan atas)");
                return;
            }
            triggerAlarm("UJI COBA");
        }

        function updateTodayStats() {
            const todayName = new Date().toLocaleDateString('id-ID', { weekday: 'long' });
            const container = document.getElementById('todayStats');

            if (todayName === 'Minggu') {
                container.innerHTML = `<div class="p-3 bg-slate-900 rounded text-center text-slate-500">Hari ini libur</div>`;
                return;
            }

            const times = alarmConfig[todayName] || {};
            const sorted = Object.keys(times).sort();

            if (sorted.length === 0) {
                 container.innerHTML = `<div class="p-3 bg-slate-900 rounded text-center text-slate-500">Tidak ada jadwal hari ini</div>`;
                 return;
            }

            let html = '<div class="grid grid-cols-2 gap-2">';
            sorted.forEach(t => {
                const isActive = times[t];
                html += `
                    <div class="flex items-center justify-between p-2 rounded ${isActive ? 'bg-blue-900/30 border border-blue-500/30' : 'bg-slate-900/30 border border-slate-700 opacity-50'}">
                        <span class="font-mono text-sm ${isActive ? 'text-blue-300' : 'text-slate-500'}">${t}</span>
                        <i class="fas ${isActive ? 'fa-check-circle text-green-500' : 'fa-times-circle text-slate-600'} text-xs"></i>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function findNextAlarm() {
            const now = new Date();
            const dayName = now.toLocaleDateString('id-ID', { weekday: 'long' });
            if (dayName === 'Minggu') {
                document.getElementById('nextAlarmTime').textContent = "Senin";
                return;
            }

            const currentHM = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false }).replace('.', ':');
            const times = alarmConfig[dayName] || {};

            const sorted = Object.keys(times).sort();
            const next = sorted.find(t => t > currentHM && times[t] === true);

            if (next) {
                document.getElementById('nextAlarmTime').textContent = next;
            } else {
                document.getElementById('nextAlarmTime').textContent = "Besok";
            }
        }

        // START
        init();

    </script>
</body>
</html>
